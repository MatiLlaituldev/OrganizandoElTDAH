<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Mi Bienestar Diario</ion-title>
  </ion-toolbar>

  <ion-toolbar class="segment-toolbar">
    <ion-segment [(ngModel)]="vistaActual" (ionChange)="segmentChanged($event)" value="registrar" mode="md">
      <ion-segment-button value="registrar">
        <ion-icon name="create-outline"></ion-icon>
        <ion-label>Registrar Hoy</ion-label>
      </ion-segment-button>
      <ion-segment-button value="historial">
        <ion-icon name="time-outline"></ion-icon>
        <ion-label>Mi Historial</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="content-wrapper">

    <div *ngIf="vistaActual === 'registrar'" class="page-view">
      <div class="welcome-header">
        <img src="assets/images/cerebrito.png" alt="Cerebrito Bienestar" class="welcome-image" />
        <div class="welcome-text">
          <h2>¿Cómo te sientes hoy?</h2>
          <p>Tómate un momento para conectar contigo.</p>
        </div>
      </div>

      <form [formGroup]="wellbeingForm" (ngSubmit)="guardarRegistro()" *ngIf="wellbeingForm">

        <div class="form-card">
          <ion-label class="card-title">Tu Estado de Ánimo</ion-label>
          <ion-segment formControlName="estadoAnimo" class="mood-segment" scrollable="true">
            <ion-segment-button *ngFor="let opcion of opcionesAnimo" [value]="opcion.valor">
              <span class="emoji">{{ opcion.emoji }}</span>
              <ion-label>{{ opcion.texto }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <div class="form-card">
          <ion-label class="card-title">Tu Nivel de Energía</ion-label>
          <ion-segment formControlName="nivelEnergia" class="mood-segment" scrollable="true">
            <ion-segment-button *ngFor="let opcion of opcionesEnergia" [value]="opcion.valor">
              <span class="emoji">{{ opcion.emoji }}</span>
              <ion-label>{{ opcion.texto }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <div class="form-card">
          <ion-label class="card-title">Notas Adicionales</ion-label>
          <ion-item class="notes-input" lines="none">
            <ion-textarea formControlName="notas" autoGrow="true" placeholder="Escribe algo sobre tu día..."></ion-textarea>
          </ion-item>
        </div>

        <div class="form-card">
          <ion-label class="card-title">Recordatorio</ion-label>
          <ion-item lines="none" class="toggle-item">
            <ion-label>Activar recordatorio diario</ion-label>
            <ion-toggle slot="end" [(ngModel)]="recordatorioActivo" [ngModelOptions]="{standalone: true}"></ion-toggle>
          </ion-item>

          <div class="time-input-container" *ngIf="recordatorioActivo">
            <ion-icon name="alarm-outline"></ion-icon>
            <ion-datetime-button datetime="reminderTime"></ion-datetime-button>
            <ion-datetime
              id="reminderTime"
              class="custom-datetime-picker"
              presentation="time"
              [(ngModel)]="horaRecordatorio"
              [ngModelOptions]="{standalone: true}"
              [min]="minHora"
              [max]="maxHora"
              hour-cycle="h23">
            </ion-datetime>
          </div>
        </div>

        <ion-button expand="block" type="submit" [disabled]="!wellbeingForm || wellbeingForm.invalid">
          Guardar
        </ion-button>
      </form>
    </div>

    <div *ngIf="vistaActual === 'historial'" class="page-view">
      <div *ngIf="(historialAnimo$ | async) as historial; else loadingHistory">
        <div *ngIf="historial.length > 0; else noHistory" class="history-list">
          <ion-item *ngFor="let registro of historial" lines="none" class="history-card">
            <div class="date-badge" slot="start">
              <span class="day">{{ registro.fecha | date:'dd' }}</span>
              <span class="month">{{ registro.fecha | date:'MMM' }}</span>
            </div>
            <ion-label>
              <div class="mood-energy-container">
                <span class="mood-item">{{ getEmojiAnimo(registro.estadoAnimo) }} {{ getTextoAnimo(registro.estadoAnimo) }}</span>
                <span class="energy-item">{{ getEmojiEnergia(registro.nivelEnergia) }} {{ getTextoEnergia(registro.nivelEnergia) }}</span>
              </div>
              <p *ngIf="registro.notas" class="notes-history">{{ registro.notas }}</p>
            </ion-label>
          </ion-item>
        </div>
        <ng-template #noHistory>
          <div class="empty-state">
            <ion-icon name="receipt-outline" class="empty-icon"></ion-icon>
            <p>Aún no tienes registros.</p>
          </div>
        </ng-template>
      </div>
      <ng-template #loadingHistory>
        <div class="loading-state">
          <ion-spinner name="dots"></ion-spinner>
          <p>Cargando historial...</p>
        </div>
      </ng-template>
    </div>

  </div>
